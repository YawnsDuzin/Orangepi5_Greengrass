# AWS IoT Greengrass 소개

## 목차
1. [AWS IoT Greengrass란?](#aws-iot-greengrass란)
2. [주요 개념](#주요-개념)
3. [아키텍처](#아키텍처)
4. [주요 기능](#주요-기능)
5. [Greengrass V2 vs V1](#greengrass-v2-vs-v1)
6. [사용 사례](#사용-사례)
7. [비용 구조](#비용-구조)
8. [사전 요구사항](#사전-요구사항)

---

## AWS IoT Greengrass란?

AWS IoT Greengrass는 **엣지 디바이스에서 AWS 클라우드 기능을 로컬로 실행**할 수 있게 해주는 오픈소스 엣지 런타임 및 클라우드 서비스입니다.

### 핵심 가치

```
┌─────────────────────────────────────────────────────────────────┐
│                    AWS IoT Greengrass                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ☁️ AWS Cloud                                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  IoT Core  │  Lambda  │  S3  │  SageMaker  │  CloudWatch │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           │                                     │
│                           │ 배포/관리                           │
│                           ▼                                     │
│  🏭 Edge (Orange Pi 5)                                         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Greengrass Core                              │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │  │
│  │  │Component│ │Component│ │Component│ │Component│       │  │
│  │  │ ML추론  │ │ MQTT   │ │ S3동기화│ │ 사용자  │       │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           │                                     │
│                           ▼                                     │
│  📷 센서/장치 (카메라, 센서, 액추에이터)                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Greengrass가 필요한 이유

| 과제 | 기존 방식 | Greengrass 솔루션 |
|------|----------|------------------|
| **지연시간** | 모든 데이터를 클라우드로 전송 → 높은 지연 | 로컬에서 실시간 처리 |
| **네트워크 의존성** | 인터넷 끊기면 동작 불가 | 오프라인에서도 동작 |
| **대역폭 비용** | 모든 데이터 전송 → 높은 비용 | 필요한 데이터만 전송 |
| **보안** | 민감 데이터가 외부로 나감 | 로컬에서 처리, 결과만 전송 |
| **관리** | 각 디바이스 개별 관리 | 중앙에서 일괄 배포/관리 |

---

## 주요 개념

### 1. Greengrass Core Device (코어 디바이스)

Greengrass 소프트웨어가 실행되는 디바이스입니다. 이 튜토리얼에서는 **Orange Pi 5**가 코어 디바이스입니다.

```
┌─────────────────────────────────────────┐
│         Greengrass Core Device          │
│              (Orange Pi 5)               │
├─────────────────────────────────────────┤
│  • Greengrass nucleus (핵심 런타임)     │
│  • 컴포넌트 런타임                       │
│  • IPC (Inter-Process Communication)   │
│  • 로컬 MQTT 브로커                     │
└─────────────────────────────────────────┘
```

### 2. Components (컴포넌트)

Greengrass에서 실행되는 소프트웨어 모듈입니다. Lambda 함수, Docker 컨테이너, 또는 일반 프로세스가 될 수 있습니다.

#### 컴포넌트 종류

| 종류 | 설명 | 예시 |
|------|------|------|
| **AWS 제공** | AWS에서 사전 구축한 컴포넌트 | MQTT 브릿지, Secret Manager |
| **커뮤니티** | 커뮤니티에서 공유하는 컴포넌트 | 센서 드라이버 |
| **사용자 정의** | 직접 개발한 컴포넌트 | ML 추론, 데이터 처리 |

#### 컴포넌트 구조

```yaml
# recipe.yaml (컴포넌트 레시피)
RecipeFormatVersion: '2020-01-25'
ComponentName: com.example.MyComponent
ComponentVersion: '1.0.0'
ComponentDescription: 사용자 정의 컴포넌트
ComponentPublisher: YourName

Manifests:
  - Platform:
      os: linux
    Lifecycle:
      Install: pip3 install -r requirements.txt
      Run: python3 main.py
    Artifacts:
      - URI: s3://my-bucket/artifacts/my-component.zip
        Unarchive: ZIP
```

### 3. Deployment (배포)

클라우드에서 코어 디바이스로 컴포넌트를 배포하는 작업입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                      배포 프로세스                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 컴포넌트 생성                                               │
│     └─▶ S3에 아티팩트 업로드                                   │
│     └─▶ 레시피 등록                                            │
│                                                                 │
│  2. 배포 생성                                                   │
│     └─▶ 대상 디바이스/그룹 선택                                │
│     └─▶ 컴포넌트 버전 선택                                     │
│     └─▶ 설정 오버라이드 (선택)                                 │
│                                                                 │
│  3. 배포 실행                                                   │
│     └─▶ 디바이스가 배포 수신                                   │
│     └─▶ 아티팩트 다운로드                                      │
│     └─▶ 컴포넌트 설치/실행                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4. Thing (사물)

AWS IoT에 등록된 디바이스를 나타내는 리소스입니다.

### 5. Thing Group (사물 그룹)

여러 사물을 논리적으로 그룹화하여 일괄 관리합니다.

```
Thing Group: "factory-floor-devices"
├── Thing: orangepi5-001
├── Thing: orangepi5-002
└── Thing: orangepi5-003
```

---

## 아키텍처

### 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           AWS Cloud                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │   AWS IoT   │  │     S3      │  │  Lambda     │  │ CloudWatch  │   │
│  │    Core     │  │  (아티팩트) │  │ (선택사항)  │  │   Logs      │   │
│  └──────┬──────┘  └──────┬──────┘  └─────────────┘  └─────────────┘   │
│         │                │                                              │
│  ┌──────┴────────────────┴──────┐                                      │
│  │     AWS IoT Greengrass       │                                      │
│  │        (클라우드 서비스)      │                                      │
│  └──────────────┬───────────────┘                                      │
│                 │                                                       │
└─────────────────┼───────────────────────────────────────────────────────┘
                  │ TLS/MQTT (포트 8883, 443)
                  │
┌─────────────────┼───────────────────────────────────────────────────────┐
│    Edge         │                                                       │
├─────────────────┼───────────────────────────────────────────────────────┤
│                 ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Greengrass Core Device                        │   │
│  │                       (Orange Pi 5)                              │   │
│  │  ┌───────────────────────────────────────────────────────────┐  │   │
│  │  │                    Greengrass Nucleus                      │  │   │
│  │  │  • 컴포넌트 라이프사이클 관리                              │  │   │
│  │  │  • 배포 수신 및 처리                                       │  │   │
│  │  │  • IPC (컴포넌트 간 통신)                                  │  │   │
│  │  └───────────────────────────────────────────────────────────┘  │   │
│  │                                                                  │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │   │
│  │  │   MQTT     │ │   Stream   │ │    ML      │ │   Custom   │   │   │
│  │  │  Bridge    │ │  Manager   │ │ Inference  │ │ Component  │   │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              │ 로컬 통신                                │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    로컬 디바이스/센서                            │   │
│  │   📷 카메라    🌡️ 온도센서    💡 액추에이터    📊 PLC          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Greengrass Nucleus 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                     Greengrass Nucleus                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Core Services                          │   │
│  │  • Deployment Service (배포 관리)                       │   │
│  │  • Component Manager (컴포넌트 라이프사이클)            │   │
│  │  • Configuration Manager (설정 관리)                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   IPC (Inter-Process Communication)      │   │
│  │  • Pub/Sub (컴포넌트 간 메시지)                         │   │
│  │  • Lifecycle (시작/중지 이벤트)                         │   │
│  │  • Configuration (설정 업데이트)                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Cloud Connectivity                     │   │
│  │  • MQTT Client (AWS IoT Core 연결)                      │   │
│  │  • HTTP Client (S3, 기타 서비스)                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 주요 기능

### 1. MQTT 메시징

로컬 및 클라우드 MQTT 메시징을 지원합니다.

```python
# 로컬 MQTT 발행 예시
import awsiot.greengrasscoreipc as ipc

ipc_client = ipc.connect()
ipc_client.publish_to_topic(
    topic="sensors/temperature",
    publish_message={"temperature": 25.5}
)
```

```
┌─────────────────────────────────────────────────────────────┐
│                    MQTT 메시지 흐름                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [센서] ──▶ [로컬 MQTT] ──▶ [컴포넌트] ──▶ [AWS IoT Core] │
│                │                                            │
│                ▼                                            │
│         [다른 로컬 구독자]                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. Stream Manager

대용량 데이터 스트림을 관리하고 클라우드로 내보냅니다.

```python
# Stream Manager 사용 예시
from stream_manager import StreamManagerClient

client = StreamManagerClient()

# 스트림 생성
client.create_message_stream(
    stream_name="video-stream",
    export_definition=ExportDefinition(
        s3_task_executor=[S3ExportTaskExecutorConfig(
            identifier="s3-export",
            s3_bucket="my-bucket"
        )]
    )
)

# 데이터 추가
client.append_message("video-stream", video_frame_data)
```

### 3. Secret Manager

AWS Secrets Manager의 시크릿을 로컬에서 안전하게 사용합니다.

### 4. ML Inference (기계학습 추론)

로컬에서 ML 모델을 실행합니다.

```
┌─────────────────────────────────────────────────────────────┐
│                   ML 추론 파이프라인                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [카메라] ─▶ [전처리] ─▶ [모델추론] ─▶ [후처리] ─▶ [결과] │
│                           (NPU)                             │
│                                                             │
│  지원 런타임:                                               │
│  • TensorFlow Lite                                         │
│  • PyTorch                                                 │
│  • ONNX Runtime                                            │
│  • RKNN (Orange Pi 5 NPU)                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5. Local Shadow

디바이스 상태를 로컬 섀도우로 관리합니다.

### 6. OTA (Over-The-Air) 업데이트

원격으로 컴포넌트를 업데이트합니다.

---

## Greengrass V2 vs V1

### 주요 차이점

| 항목 | Greengrass V1 | Greengrass V2 |
|------|---------------|---------------|
| **아키텍처** | 모놀리식 | 모듈식 (컴포넌트 기반) |
| **배포 단위** | Lambda 함수 중심 | 컴포넌트 (다양한 형태) |
| **설치** | 복잡한 수동 설정 | 간편한 자동 프로비저닝 |
| **컨테이너** | Docker 필수 | Docker 선택사항 |
| **로컬 개발** | 제한적 | 로컬 CLI 도구 지원 |
| **오픈소스** | 일부 | 전체 (Apache 2.0) |

### V2 선택 이유

```
✅ 이 튜토리얼에서는 Greengrass V2를 사용합니다.

이유:
• 최신 버전으로 AWS에서 권장
• 컴포넌트 기반으로 유연한 구성
• Python 스크립트를 직접 컴포넌트로 실행 가능
• 간편한 설치 및 관리
• 오픈소스로 커뮤니티 활발
```

---

## 사용 사례

### 1. 산업용 IoT (IIoT)

```
┌─────────────────────────────────────────────────────────────────┐
│                    스마트 팩토리 시나리오                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [생산 라인]                                                   │
│      │                                                         │
│      ▼                                                         │
│  [센서 데이터] ──▶ [Greengrass] ──▶ [품질 검사 AI]           │
│                         │                                      │
│                         ├──▶ 불량품 → 알림                     │
│                         └──▶ 통계 → AWS 클라우드               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 영상 분석

```
┌─────────────────────────────────────────────────────────────────┐
│                   PPE 감지 시나리오                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [RTSP 카메라] ──▶ [Greengrass] ──▶ [PPE 감지 모델]          │
│                         │                                      │
│                         ├──▶ 안전장비 미착용 → 경보            │
│                         └──▶ 이벤트 로그 → CloudWatch          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3. 예측 유지보수

```
┌─────────────────────────────────────────────────────────────────┐
│                   설비 모니터링 시나리오                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [진동 센서] ──▶ [Greengrass] ──▶ [이상 감지 모델]           │
│  [온도 센서] ──▶      │                                        │
│                       ├──▶ 이상 징후 → 유지보수 알림           │
│                       └──▶ 시계열 데이터 → S3 저장            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 비용 구조

### Greengrass 비용 (2024년 기준)

| 항목 | 비용 | 비고 |
|------|------|------|
| **Core Device** | 무료 | 코어 디바이스 자체는 무료 |
| **Connected Devices** | $0.16/월/디바이스 | 처음 10,000대까지 |
| **IoT Core 메시지** | $1.00/백만 메시지 | 처음 10억 메시지 |
| **S3 저장소** | $0.023/GB/월 | 표준 스토리지 |

### 예상 비용 예시

```
월간 예상 비용 (소규모 PoC 기준)

Core Device: 1대 ─────────────────── $0.00
IoT Core 메시지: 100만/월 ────────── $1.00
S3 저장소: 10GB ──────────────────── $0.23
데이터 전송: 1GB ─────────────────── $0.09
                                    ─────────
                          총계: 약 $1.32/월
```

---

## 사전 요구사항

### AWS 계정 설정

Greengrass를 사용하려면 다음이 필요합니다:

#### 1. AWS 계정

- AWS 계정이 없다면 [여기](https://aws.amazon.com/)에서 생성
- Free Tier 계정으로 시작 가능

#### 2. IAM 사용자 및 권한

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "greengrass:*",
                "iot:*",
                "iam:CreateRole",
                "iam:AttachRolePolicy",
                "iam:GetRole",
                "iam:PassRole",
                "s3:CreateBucket",
                "s3:PutObject",
                "s3:GetObject"
            ],
            "Resource": "*"
        }
    ]
}
```

#### 3. AWS CLI 설치 및 구성

```bash
# AWS CLI 설치 (Orange Pi 5)
curl "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# AWS 자격 증명 구성
aws configure
# AWS Access Key ID: [입력]
# AWS Secret Access Key: [입력]
# Default region name: ap-northeast-2  # 서울 리전
# Default output format: json

# 확인
aws sts get-caller-identity
```

### Orange Pi 5 요구사항

| 항목 | 요구사항 |
|------|----------|
| **OS** | Linux (Debian 11+, Ubuntu 20.04+) |
| **Python** | 3.8 이상 |
| **Java** | 8 또는 11 |
| **메모리** | 최소 128MB (권장 512MB+) |
| **저장공간** | 최소 256MB (권장 1GB+) |
| **네트워크** | 인터넷 연결 (MQTT 8883, HTTPS 443) |

### 네트워크 요구사항

```
┌─────────────────────────────────────────────────────────────────┐
│                    필수 아웃바운드 연결                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Orange Pi 5 ──▶ [포트 8883/TCP] ──▶ AWS IoT Core             │
│              ──▶ [포트 443/TCP]  ──▶ AWS IoT Greengrass       │
│              ──▶ [포트 443/TCP]  ──▶ Amazon S3                │
│                                                                 │
│  방화벽 설정:                                                   │
│  • 인바운드: 필요 없음 (아웃바운드만 필요)                     │
│  • 아웃바운드: 8883, 443 TCP 허용                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 다음 단계

AWS IoT Greengrass의 기본 개념을 이해했습니다. 다음 문서에서는 실제로 Orange Pi 5에 Greengrass Core를 설치하고 AWS와 연결합니다.

➡️ [04. 엣지 디바이스에 Greengrass 설치](./04-greengrass-edge-device-setup.md)

---

## 참고 자료

- [AWS IoT Greengrass 공식 문서](https://docs.aws.amazon.com/greengrass/)
- [AWS IoT Greengrass V2 개발자 가이드](https://docs.aws.amazon.com/greengrass/v2/developerguide/)
- [AWS IoT Greengrass GitHub](https://github.com/aws-greengrass)
- [AWS IoT Core 요금](https://aws.amazon.com/iot-core/pricing/)
